Subject: [PATCH] mapstructplus-3
---
Index: backend/domain/src/main/java/com/personal/portfolio/blog/domain/model/User.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/backend/domain/src/main/java/com/personal/portfolio/blog/domain/model/User.java b/backend/domain/src/main/java/com/personal/portfolio/blog/domain/model/User.java
--- a/backend/domain/src/main/java/com/personal/portfolio/blog/domain/model/User.java	(revision a66ce81a40863aa56ddfb9c2aa720b2c26d60a11)
+++ b/backend/domain/src/main/java/com/personal/portfolio/blog/domain/model/User.java	(date 1765427406178)
@@ -1,21 +1,21 @@
 package com.personal.portfolio.blog.domain.model;
 
 import lombok.Getter;
-import com.baomidou.mybatisplus.annotation.*;
+import lombok.Setter;
 
 import java.time.LocalDateTime;
 
 /**
  * 用户实体类 - 充血模型实现
+ * 纯领域模型，不包含任何持久化注解
  */
-@TableName("users")
 @Getter
+@Setter
 public class User {
     
     /**
      * 用户ID，主键，自增
      */
-    @TableId(type = IdType.AUTO)
     private Long id;
     
     /**
@@ -105,8 +105,9 @@
     
     /**
      * 保护性构造函数（JPA/MyBatis需要）
+     * 改为public以支持MapStruct映射
      */
-    protected User() {
+    public User() {
         this.createdAt = LocalDateTime.now();
         this.updatedAt = LocalDateTime.now();
     }
Index: backend/startup/src/main/java/com/personal/portfolio/PersonalPortfolioApplication.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/backend/startup/src/main/java/com/personal/portfolio/PersonalPortfolioApplication.java b/backend/startup/src/main/java/com/personal/portfolio/PersonalPortfolioApplication.java
--- a/backend/startup/src/main/java/com/personal/portfolio/PersonalPortfolioApplication.java	(revision a66ce81a40863aa56ddfb9c2aa720b2c26d60a11)
+++ b/backend/startup/src/main/java/com/personal/portfolio/PersonalPortfolioApplication.java	(date 1765423740879)
@@ -1,9 +1,11 @@
 package com.personal.portfolio;
 
+import org.mybatis.spring.annotation.MapperScan;
 import org.springframework.boot.SpringApplication;
 import org.springframework.boot.autoconfigure.SpringBootApplication;
 
 @SpringBootApplication
+@MapperScan("com.personal.portfolio.blog.infrastructure.persistence.mapper")
 public class PersonalPortfolioApplication {
 
     public static void main(String[] args) {
Index: backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/mapper/UserMapper.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/mapper/UserMapper.java b/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/mapper/UserMapper.java
--- a/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/mapper/UserMapper.java	(revision a66ce81a40863aa56ddfb9c2aa720b2c26d60a11)
+++ b/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/mapper/UserMapper.java	(date 1765427144942)
@@ -1,34 +1,35 @@
 package com.personal.portfolio.blog.infrastructure.persistence.mapper;
 
 import com.baomidou.mybatisplus.core.mapper.BaseMapper;
-import com.personal.portfolio.blog.domain.model.User;
+import com.personal.portfolio.blog.infrastructure.persistence.entity.UserEntity;
 import org.apache.ibatis.annotations.Mapper;
 import org.apache.ibatis.annotations.Param;
 import org.apache.ibatis.annotations.Select;
 
 /**
  * 用户数据访问接口 - MyBatis Plus Mapper
+ * 操作持久化实体 UserEntity
  */
 @Mapper
-public interface UserMapper extends BaseMapper<User> {
+public interface UserMapper extends BaseMapper<UserEntity> {
     
     /**
      * 根据GitHub ID查找用户
      */
     @Select("SELECT * FROM users WHERE github_id = #{githubId}")
-    User selectByGithubId(@Param("githubId") String githubId);
+    UserEntity selectByGithubId(@Param("githubId") String githubId);
     
     /**
      * 根据用户名查找用户
      */
     @Select("SELECT * FROM users WHERE username = #{username}")
-    User selectByUsername(@Param("username") String username);
+    UserEntity selectByUsername(@Param("username") String username);
     
     /**
      * 根据邮箱查找用户
      */
     @Select("SELECT * FROM users WHERE email = #{email}")
-    User selectByEmail(@Param("email") String email);
+    UserEntity selectByEmail(@Param("email") String email);
     
     /**
      * 检查用户名是否已存在
Index: backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/UserRepositoryImpl.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/UserRepositoryImpl.java b/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/UserRepositoryImpl.java
--- a/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/UserRepositoryImpl.java	(revision a66ce81a40863aa56ddfb9c2aa720b2c26d60a11)
+++ b/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/UserRepositoryImpl.java	(date 1765435636521)
@@ -3,11 +3,16 @@
 import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
 import com.personal.portfolio.blog.domain.model.User;
 import com.personal.portfolio.blog.domain.repository.UserRepository;
+import com.personal.portfolio.blog.infrastructure.persistence.entity.UserEntity;
 import com.personal.portfolio.blog.infrastructure.persistence.mapper.UserMapper;
+
 import org.springframework.stereotype.Repository;
 
 import java.util.List;
 import java.util.Optional;
+import java.util.stream.Collectors;
+
+import io.github.linpeilie.Converter;
 
 /**
  * 用户仓储实现类 - 使用MyBatis Plus
@@ -16,54 +21,62 @@
 public class UserRepositoryImpl implements UserRepository {
     
     private final UserMapper userMapper;
-    
+
+    private static final Converter converter = new Converter();
+
     public UserRepositoryImpl(UserMapper userMapper) {
         this.userMapper = userMapper;
     }
     
     @Override
     public User save(User user) {
-        if (user.getId() == null) {
+        UserEntity userEntity = converter.convert(user, UserEntity.class);;
+
+        if (userEntity.getId() == null) {
             // 新增
-            user.preUpdate();
-            userMapper.insert(user);
+            userEntity.setUpdatedAt(java.time.LocalDateTime.now());
+            userMapper.insert(userEntity);
         } else {
             // 更新
-            user.preUpdate();
-            userMapper.updateById(user);
+            userEntity.setUpdatedAt(java.time.LocalDateTime.now());
+            userMapper.updateById(userEntity);
         }
-        return user;
+        // 更新ID（如果是新增）
+        return converter.convert(userEntity, User.class);
     }
     
     @Override
     public Optional<User> findById(Long id) {
-        User user = userMapper.selectById(id);
-        return Optional.ofNullable(user);
+        UserEntity userEntity = userMapper.selectById(id);
+        return Optional.ofNullable(userEntity).map(entity -> converter.convert(entity, User.class));
     }
     
     @Override
     public Optional<User> findByGithubId(String githubId) {
-        User user = userMapper.selectByGithubId(githubId);
-        return Optional.ofNullable(user);
+        UserEntity userEntity = userMapper.selectByGithubId(githubId);
+        return Optional.ofNullable(userEntity).map(entity -> converter.convert(entity, User.class));
     }
     
     @Override
     public Optional<User> findByUsername(String username) {
-        User user = userMapper.selectByUsername(username);
-        return Optional.ofNullable(user);
+        UserEntity userEntity = userMapper.selectByUsername(username);
+        return Optional.ofNullable(userEntity).map(entity -> converter.convert(entity, User.class));
     }
     
     @Override
     public Optional<User> findByEmail(String email) {
-        User user = userMapper.selectByEmail(email);
-        return Optional.ofNullable(user);
+        UserEntity userEntity = userMapper.selectByEmail(email);
+        return Optional.ofNullable(userEntity).map(entity -> converter.convert(entity, User.class));
     }
     
     @Override
     public List<User> findAll() {
-        LambdaQueryWrapper<User> queryWrapper = new LambdaQueryWrapper<>();
-        queryWrapper.orderByDesc(User::getCreatedAt);
-        return userMapper.selectList(queryWrapper);
+        LambdaQueryWrapper<UserEntity> queryWrapper = new LambdaQueryWrapper<>();
+        queryWrapper.orderByDesc(UserEntity::getCreatedAt);
+        List<UserEntity> entities = userMapper.selectList(queryWrapper);
+        return entities.stream()
+                .map(entity -> converter.convert(entity, User.class))
+                .collect(Collectors.toList());
     }
     
     @Override
Index: backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/entity/UserEntity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/entity/UserEntity.java b/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/entity/UserEntity.java
new file mode 100644
--- /dev/null	(date 1765435521203)
+++ b/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/entity/UserEntity.java	(date 1765435521203)
@@ -0,0 +1,83 @@
+package com.personal.portfolio.blog.infrastructure.persistence.entity;
+
+import com.baomidou.mybatisplus.annotation.*;
+import com.personal.portfolio.blog.domain.model.User;
+
+import io.github.linpeilie.annotations.AutoMapper;
+import lombok.Getter;
+import lombok.Setter;
+
+import java.time.LocalDateTime;
+
+/**
+ * 用户持久化实体
+ * 包含MyBatis Plus注解，专注于数据存储
+ */
+@Getter
+@Setter
+@TableName("users")
+@AutoMapper(target = User.class)
+public class UserEntity {
+    
+    @TableId(type = IdType.AUTO)
+    private Long id;
+    
+    @TableField("github_id")
+    private String githubId;
+    
+    @TableField("username")
+    private String username;
+    
+    @TableField("email")
+    private String email;
+    
+    @TableField("display_name")
+    private String displayName;
+    
+    @TableField("avatar_url")
+    private String avatarUrl;
+    
+    @TableField("bio")
+    private String bio;
+    
+    @TableField("location")
+    private String location;
+    
+    @TableField("company")
+    private String company;
+    
+    @TableField("website")
+    private String website;
+    
+    @TableField("twitter_username")
+    private String twitterUsername;
+    
+    @TableField("public_repos")
+    private Integer publicRepos = 0;
+    
+    @TableField("followers")
+    private Integer followers = 0;
+    
+    @TableField("following")
+    private Integer following = 0;
+    
+    @TableField("password")
+    private String password;
+    
+    @TableField("is_local_account")
+    private Boolean isLocalAccount = true;
+
+    @TableField(value = "created_at", fill = FieldFill.INSERT)
+    private LocalDateTime createdAt;
+
+    @TableField(value = "updated_at", fill = FieldFill.INSERT_UPDATE)
+    private LocalDateTime updatedAt;
+    
+    /**
+     * 默认构造函数
+     */
+    public UserEntity() {
+        this.createdAt = LocalDateTime.now();
+        this.updatedAt = LocalDateTime.now();
+    }
+}
Index: backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/entity/BlogPostEntity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/entity/BlogPostEntity.java b/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/entity/BlogPostEntity.java
--- a/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/entity/BlogPostEntity.java	(revision a66ce81a40863aa56ddfb9c2aa720b2c26d60a11)
+++ b/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/entity/BlogPostEntity.java	(date 1765435196331)
@@ -53,11 +53,11 @@
     
     @TableField("comment_count")
     private Integer commentCount;
-    
-    @TableField("created_at")
+
+    @TableField(value = "created_at", fill = FieldFill.INSERT)
     private LocalDateTime createdAt;
-    
-    @TableField("updated_at")
+
+    @TableField(value = "updated_at", fill = FieldFill.INSERT_UPDATE)
     private LocalDateTime updatedAt;
     
     @TableField("published_at")
Index: backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/config/MetaObjectConfig.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/config/MetaObjectConfig.java b/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/config/MetaObjectConfig.java
new file mode 100644
--- /dev/null	(date 1765435126355)
+++ b/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/config/MetaObjectConfig.java	(date 1765435126355)
@@ -0,0 +1,37 @@
+package com.personal.portfolio.blog.infrastructure.config;
+
+import com.baomidou.mybatisplus.core.handlers.MetaObjectHandler;
+import lombok.extern.slf4j.Slf4j;
+import org.apache.ibatis.reflection.MetaObject;
+import org.springframework.stereotype.Component;
+
+import java.time.LocalDateTime;
+
+/**
+ * MyBatis Plus 自动填充处理器
+ * 用于自动填充创建时间、更新时间等字段
+ */
+@Slf4j
+@Component  // 关键：必须加这个注解！
+public class MetaObjectConfig implements MetaObjectHandler {
+
+    /**
+     * 插入时自动填充
+     */
+    @Override
+    public void insertFill(MetaObject metaObject) {
+        // 填充创建时间
+        this.strictInsertFill(metaObject, "createdAt", LocalDateTime.class, LocalDateTime.now());
+        // 填充更新时间
+        this.strictInsertFill(metaObject, "updatedAt", LocalDateTime.class, LocalDateTime.now());
+    }
+
+    /**
+     * 更新时自动填充
+     */
+    @Override
+    public void updateFill(MetaObject metaObject) {
+        // 更新时只填充更新时间
+        this.strictUpdateFill(metaObject, "updatedAt", LocalDateTime.class, LocalDateTime.now());
+    }
+}
Index: backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/BlogPostRepositoryImpl.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/BlogPostRepositoryImpl.java b/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/BlogPostRepositoryImpl.java
--- a/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/BlogPostRepositoryImpl.java	(revision a66ce81a40863aa56ddfb9c2aa720b2c26d60a11)
+++ b/backend/infrastructure/src/main/java/com/personal/portfolio/blog/infrastructure/persistence/BlogPostRepositoryImpl.java	(date 1765435521277)
@@ -37,7 +37,7 @@
         boolean isNew = blogPost.getId() == null;
         
         // 转换为持久化实体
-        BlogPostEntity entity = converter.convert(blogPost, BlogPostEntity.class);;
+        BlogPostEntity entity = converter.convert(blogPost, BlogPostEntity.class);
         
         if (isNew) {
             // 新增
